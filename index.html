<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Sharing</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://www.gstatic.com https://cdnjs.cloudflare.com; object-src 'none';">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f5f5f5; padding: 15px; padding-bottom: 60px; margin: 0; }
        nav { position: fixed; bottom: 0; width: 100%; background-color: #2c3e50; display: flex; justify-content: space-around; padding: 8px 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.2); z-index: 1000; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; background: none; border: none; color: white; font-size: 10px; padding: 5px; cursor: pointer; transition: transform 0.2s ease, color 0.2s ease; border-radius: 6px; }
        .nav-btn:hover { transform: scale(1.1); color: #3498db; }
        .nav-btn span { margin-top: 2px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .file-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .file-item { background-color: #ffffff; padding: 15px; border-radius: 10px; border: 2px solid #3498db; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.3s ease; }
        .file-item:hover { transform: translateY(-5px); }
        .file-info { margin-bottom: 10px; }
        .file-name { color: #3498db; font-weight: 600; font-size: 16px; }
        .file-details { color: #555; font-size: 12px; margin-top: 4px; }
        .download-btn { background-color: #3498db; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.3s ease; width: 100%; }
        .download-btn:hover { background-color: #5dade2; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-content { background-color: #ffffff; padding: 20px; border-radius: 10px; border: 2px solid #3498db; width: 90%; max-width: 340px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .modal-content h2 { margin-bottom: 15px; color: #2c3e50; font-size: 22px; font-weight: 700; text-align: center; }
        .modal-content p { margin: 10px 0; font-size: 14px; }
        .modal-content button { background-color: #3498db; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.3s ease; width: 100%; }
        .modal-content button:hover { background-color: #5dade2; }
        @media (max-width: 600px) { .file-list { grid-template-columns: 1fr; } .file-item { padding: 12px; } .nav-btn { font-size: 9px; padding: 3px; } .modal-content { padding: 12px; } }
    </style>
</head>
<body>
    <nav>
        <button class="nav-btn" id="admin-btn" aria-label="Admin Login"><span>ðŸ”‘</span><span>Admin</span></button>
    </nav>
    <div class="container">
        <div id="fileList" class="file-list"></div>
    </div>
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h2>Admin Profile</h2>
            <p id="admin-email">Email: Loading...</p>
            <p id="admin-uid">UID: Loading...</p>
            <button id="redirect-admin-btn" aria-label="Go to Admin Page">Go to Admin Page</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2TT6oEZu6zLo5bvVDN2ctIV6VArO-kn0",
            authDomain: "download-9b2c6.firebaseapp.com",
            databaseURL: "https://download-9b2c6-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "download-9b2c6",
            storageBucket: "download-9b2c6.firebasestorage.app",
            messagingSenderId: "749735866081",
            appId: "1:749735866081:web:236175aa5f605d224ed1a0"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        const ENCRYPTION_KEY = 'securePassphrase123';

        function decryptData(encryptedData) {
            try { 
                const bytes = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY); 
                const decrypted = bytes.toString(CryptoJS.enc.Utf8); 
                if (!decrypted) throw new Error("Decryption empty"); 
                return decrypted; 
            } catch (e) { console.error("Decryption error:", e); return null; }
        }

        function sanitizeInput(input) { const div = document.createElement("div"); div.textContent = input; return div.innerHTML; }

        function loadFiles() {
            const fileList = document.getElementById("fileList");
            fileList.innerHTML = "<p>Loading...</p>";
            db.ref("sharedFiles").on("value", (snapshot) => {
                fileList.innerHTML = "";
                if (!snapshot.exists()) { fileList.innerHTML = "<p>No files available.</p>"; return; }
                const files = [];
                snapshot.forEach((childSnapshot) => {
                    const fileData = childSnapshot.val();
                    if (fileData && fileData.fileName && fileData.fileContent) {
                        files.push({ id: childSnapshot.key, ...fileData });
                    }
                });
                if (files.length === 0) { fileList.innerHTML = "<p>No valid files found.</p>"; return; }
                files.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
                files.forEach((file) => {
                    const uploadDate = new Date(file.uploadDate).toLocaleString("en-GB");
                    const fileItem = document.createElement("div");
                    fileItem.className = "file-item";
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-name">${sanitizeInput(file.fileName)}</div>
                            <div class="file-details">Uploaded: ${uploadDate}</div>
                        </div>
                        <button class="download-btn" onclick="downloadFile('${file.id}', '${sanitizeInput(file.fileName)}')">Download</button>
                    `;
                    fileList.appendChild(fileItem);
                });
            }, (error) => {
                console.error("Database error:", error);
                fileList.innerHTML = "<p>Error loading files.</p>";
            });
        }

        window.downloadFile = function(fileId, fileName) {
            db.ref(`sharedFiles/${fileId}`).once("value").then((snapshot) => {
                const fileData = snapshot.val();
                if (!fileData || !fileData.fileContent) { alert("File not found or corrupted."); return; }
                const decryptedData = decryptData(fileData.fileContent);
                if (!decryptedData) { alert("Decryption failed."); return; }
                try {
                    const byteCharacters = atob(decryptedData);
                    const byteNumbers = new Uint8Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) byteNumbers[i] = byteCharacters.charCodeAt(i);
                    const blob = new Blob([byteNumbers], { type: fileData.fileType || "application/octet-stream" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (e) {
                    console.error("Download error:", e);
                    alert("Error processing file.");
                }
            }).catch((error) => {
                console.error("Fetch error:", error);
                alert("Error retrieving file.");
            });
        };

        document.addEventListener("DOMContentLoaded", () => {
            if (typeof firebase === "undefined" || typeof CryptoJS === "undefined") {
                document.getElementById("fileList").innerHTML = "<p>Libraries failed to load.</p>";
                return;
            }

            loadFiles();

            const adminBtn = document.getElementById("admin-btn");
            const adminModal = document.getElementById("admin-modal");
            const redirectAdminBtn = document.getElementById("redirect-admin-btn");
            const adminEmail = document.getElementById("admin-email");
            const adminUid = document.getElementById("admin-uid");

            adminBtn.addEventListener("click", () => {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        adminEmail.textContent = `Email: ${user.email || "Not provided"}`;
                        adminUid.textContent = `UID: ${user.uid || "Not provided"}`;
                        adminModal.classList.add("show");
                    } else {
                        alert("Please log in to access the admin page.");
                        window.location.href = "login.html";
                    }
                });
            });

            redirectAdminBtn.addEventListener("click", () => {
                window.location.href = "admin.html";
            });

            document.addEventListener("click", (e) => {
                if (!adminModal.querySelector(".modal-content").contains(e.target) && !e.target.closest("#admin-btn") && adminModal.classList.contains("show")) {
                    adminModal.classList.remove("show");
                }
            });
        });
    </script>
</body>
</html>
