<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>File Sharing</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" media="print" onload="this.media='all'">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 60px;
            background-color: #f5f5f5;
            color: #333;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #2c3e50;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            color: white;
            font-size: 10px;
            padding: 5px;
            cursor: pointer;
            transition: transform 0.2s ease, color 0.2s ease, background-color 0.2s ease;
            border-radius: 6px;
            position: relative;
        }

        .nav-btn:hover, .nav-btn:active {
            transform: scale(1.1) rotate(2deg);
            color: #3498db;
            background-color: rgba(52, 152, 219, 0.1);
        }

        .nav-btn span {
            margin-top: 2px;
            transition: transform 0.2s ease;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #3498db;
            width: 90%;
            max-width: 340px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: slideUp 0.4s ease;
        }

        .modal-content h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 22px;
            font-weight: 700;
            position: relative;
        }

        .modal-content h2::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, #3498db, #5dade2);
        }

        .file-item {
            padding: 8px;
            border-bottom: 1px solid #d1d8e0;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            color: #3498db;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .file-name:hover {
            color: #5dade2;
        }

        .download-link {
            color: #3498db;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .download-link:hover {
            color: #5dade2;
        }

        .file-details {
            font-size: 12px;
            color: #555;
            margin-top: 4px;
        }

        .no-files {
            color: #e74c3c;
            font-size: 14px;
            text-align: center;
            padding: 10px;
        }

        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        body.dark-mode nav {
            background-color: #1e1e1e;
            box-shadow: 0 2px 5px rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .modal-content {
            background: linear-gradient(180deg, #1e1e1e, #252525);
            color: #ffffff;
            border-color: #bb86fc;
        }

        body.dark-mode .modal-content h2 {
            color: #ffffff;
        }

        body.dark-mode .modal-content h2::after {
            background: linear-gradient(90deg, #bb86fc, #03dac6);
        }

        body.dark-mode .file-item {
            border-bottom: 1px solid #bb86fc;
        }

        body.dark-mode .file-details {
            color: #aaaaaa;
        }

        body.dark-mode .file-name,
        body.dark-mode .download-link {
            color: #bb86fc;
        }

        body.dark-mode .file-name:hover,
        body.dark-mode .download-link:hover {
            color: #03dac6;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 600px) {
            .nav-btn {
                font-size: 9px;
                padding: 3px;
            }
            .modal-content {
                width: 90%;
                padding: 12px;
            }
            .modal-content h2 {
                font-size: 20px;
            }
            .file-item {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <nav>
        <button class="nav-btn" id="files-btn" aria-label="Shared Files"><span>üìÅ</span><span>Shared Files</span></button>
        <button class="nav-btn" id="dark-mode-toggle" aria-label="Toggle dark mode"><span>üåô</span><span>Dark Mode</span></button>
    </nav>
    <div id="files-modal" class="modal files-modal">
        <div class="modal-content">
            <h2>Shared Files</h2>
            <div id="shared-files-list"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        (function() {
            // Ensure Firebase is loaded
            if (typeof firebase === 'undefined') {
                console.error('Firebase failed to load');
                document.getElementById('shared-files-list').innerHTML = '<div class="no-files">Failed to load file system. Please check your internet connection.</div>';
                return;
            }

            // Firebase Configuration
            const firebaseConfig = {
                apiKey: "AIzaSyD2TT6oEZu6zLo5bvVDN2ctIV6VArO-kn0",
                authDomain: "download-9b2c6.firebaseapp.com",
                databaseURL: "https://download-9b2c6-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "download-9b2c6",
                storageBucket: "download-9b2c6.firebasestorage.app",
                messagingSenderId: "749735866081",
                appId: "1:749735866081:web:236175aa5f605d224ed1a0"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();

            // Base passphrase
            const BASE_PASSPHRASE = 'ISET_Siliana_Secure_2025!@#$';

            // Derive encryption key
            function deriveKey(salt) {
                return CryptoJS.PBKDF2(BASE_PASSPHRASE, salt, {
                    keySize: 256 / 32,
                    iterations: 10000
                }).toString();
            }

            // Dark Mode Toggle
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                const toggleButton = document.getElementById('dark-mode-toggle');
                toggleButton.querySelector('span:first-child').textContent = 'üåû';
                toggleButton.querySelector('span:last-child').textContent = 'Light Mode';
            }

            // Load shared files
            const sharedFilesList = document.getElementById('shared-files-list');
            const filesModal = document.getElementById('files-modal');

            db.ref('sharedFiles').on('value', (snapshot) => {
                sharedFilesList.innerHTML = '';
                const files = [];
                snapshot.forEach(childSnapshot => {
                    const fileData = childSnapshot.val();
                    files.push({ id: childSnapshot.key, ...fileData });
                });

                if (files.length === 0) {
                    sharedFilesList.innerHTML = `<div class="no-files">No files shared yet</div>`;
                } else {
                    files.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
                    files.forEach(file => {
                        const uploadDate = new Date(file.uploadDate);
                        const formattedDate = uploadDate.toLocaleDateString('en-GB', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        }) + ', ' + uploadDate.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });

                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `
                            <div class="file-info">
                                <span class="file-name">${file.fileName}</span>
                                <div class="file-details">
                                    Uploaded by: ${file.professorName || 'N/A'} (${file.subject || 'N/A'})<br>
                                    ${formattedDate}
                                </div>
                            </div>
                            <a href="#" class="download-link" data-id="${file.id}" data-filename="${file.fileName}" data-type="${file.fileType || 'application/octet-stream'}" data-salt="${file.salt || ''}">Download</a>
                        `;
                        sharedFilesList.appendChild(fileItem);
                    });

                    document.querySelectorAll('.download-link').forEach(link => {
                        link.addEventListener('click', async (e) => {
                            e.preventDefault();
                            const fileId = link.dataset.id;
                            const fileName = link.dataset.filename;
                            const fileType = link.dataset.type;
                            const salt = link.dataset.salt;

                            try {
                                const fileSnapshot = await db.ref(`sharedFiles/${fileId}`).once('value');
                                const fileData = fileSnapshot.val();
                                const encryptedData = fileData.chunks ? fileData.chunks.join('') : fileData.fileContent;
                                const key = deriveKey(salt || '');
                                const decrypted = CryptoJS.AES.decrypt(encryptedData, key);
                                const decryptedBase64 = decrypted.toString(CryptoJS.enc.Base64);
                                if (!decryptedBase64) {
                                    throw new Error('Decryption resulted in empty data');
                                }
                                const base64String = `data:${fileType};base64,${decryptedBase64}`;

                                const downloadAnchor = document.createElement('a');
                                downloadAnchor.href = base64String;
                                downloadAnchor.download = fileName;
                                document.body.appendChild(downloadAnchor);
                                downloadAnchor.click();
                                document.body.removeChild(downloadAnchor);
                            } catch (error) {
                                console.error('Download error:', error);
                                alert(`Error downloading file: ${error.message}`);
                            }
                        });
                    });
                }
            }, (error) => {
                console.error('Database error:', error);
                sharedFilesList.innerHTML = '<div class="no-files">Error loading files</div>';
            });

            // Event Listeners
            document.getElementById('files-btn').addEventListener('click', () => {
                filesModal.classList.add('show');
            });

            document.getElementById('dark-mode-toggle').addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                const toggleButton = document.getElementById('dark-mode-toggle');
                toggleButton.querySelector('span:first-child').textContent = isDarkMode ? 'üåû' : 'üåô';
                toggleButton.querySelector('span:last-child').textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
                localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            });

            // Close modal when clicking outside
            document.addEventListener('click', (e) => {
                if (!filesModal.querySelector('.modal-content').contains(e.target) && !e.target.closest('#files-btn') && filesModal.classList.contains('show')) {
                    filesModal.classList.remove('show');
                }
            });
        })();
    </script>
</body>
</html>
