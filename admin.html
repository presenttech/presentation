<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://www.gstatic.com https://cdnjs.cloudflare.com; object-src 'none';">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f8fafc; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        .upload-btn { padding: 12px 24px; background: #3182ce; color: #ffffff; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background 0.3s ease; }
        .upload-btn:hover { background: #63b3ed; }
        @media (max-width: 600px) { .container { padding: 10px; } }
    </style>
</head>
<body>
    <div class="container">
        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.ppt,.pptx,.txt" class="mb-4 w-full">
        <button id="uploadButton" class="upload-btn w-full">Upload</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2TT6oEZu6zLo5bvVDN2ctIV6VArO-kn0",
            authDomain: "download-9b2c6.firebaseapp.com",
            databaseURL: "https://download-9b2c6-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "download-9b2c6",
            storageBucket: "download-9b2c6.firebasestorage.app",
            messagingSenderId: "749735866081",
            appId: "1:749735866081:web:236175aa5f605d224ed1a0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const ENCRYPTION_KEY = 'securePassphrase123';

        function encryptData(data) {
            try { return CryptoJS.AES.encrypt(data, ENCRYPTION_KEY).toString(); } catch (e) { console.error("Encryption error:", e); return null; }
        }

        function sanitizeInput(input) { const div = document.createElement("div"); div.textContent = input; return div.innerHTML; }

        const fileInput = document.getElementById("fileInput");
        const uploadButton = document.getElementById("uploadButton");

        uploadButton.addEventListener("click", () => {
            const file = fileInput.files[0];
            if (!file) { alert("Please select a file."); return; }
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) { alert("File too large. Max 10 MB."); return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64String = e.target.result.split(",")[1];
                if (!base64String) { alert("Failed to read file."); return; }
                const encryptedData = encryptData(base64String);
                if (!encryptedData) { alert("Encryption failed."); return; }
                const fileName = sanitizeInput(file.name);
                const fileType = file.type || "application/octet-stream";
                const uploadDate = new Date().toISOString();
                db.ref("sharedFiles").push().set({
                    fileName,
                    fileType,
                    fileContent: encryptedData,
                    uploadDate
                }).then(() => {
                    alert("File uploaded successfully.");
                    fileInput.value = "";
                }).catch((error) => { console.error("Upload error:", error); alert("Upload failed."); });
            };
            reader.onerror = (e) => { console.error("Read error:", e); alert("Error reading file."); };
            reader.readAsDataURL(file);
        });
    </script>
</body>
</html>
